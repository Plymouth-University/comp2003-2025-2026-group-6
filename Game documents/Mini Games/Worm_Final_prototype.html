<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cyber Worm - CTF Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Courier+Prime:wght@400;700&display=swap');

        :root {
            --bg-color: #0a192f;
            --game-bg: #020c1b;
            --text-color: #e6f1ff;
            --accent: #64ffda;
            --danger: #ff6b6b;
            --grid-line: #112240;
            --kahoot-purple: #46178f;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier Prime', monospace;
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            gap: 40px;
        }

        h1 {
            color: var(--accent);
            margin: 0 0 20px 0;
            text-align: center;
            text-shadow: 0 0 10px rgba(100, 255, 218, 0.2);
        }

        /* GAME WRAPPER */
        .game-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #game-area {
            position: relative;
            border: 4px solid var(--grid-line);
            box-shadow: 0 0 30px rgba(0,0,0,0.6);
            background-color: var(--game-bg);
            width: 600px;
            height: 600px;
            overflow: hidden;
        }

        canvas { display: block; }

        /* OVERLAYS */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 25, 47, 0.98);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .hidden { display: none !important; }

        .overlay h2 { font-size: 2.5rem; margin-bottom: 0.5rem; }
        .overlay p { font-size: 1.1rem; color: #8892b0; margin-bottom: 1rem; }
        
        button {
            background: transparent;
            color: var(--accent);
            border: 2px solid var(--accent);
            padding: 12px 24px;
            font-family: inherit;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            text-transform: uppercase;
            margin-top: 20px;
        }

        button:hover {
            background: rgba(100, 255, 218, 0.1);
            box-shadow: 0 0 15px rgba(100, 255, 218, 0.3);
        }

        /* KAHOOT STYLE FAKEOUT */
        .kahoot-bg {
            background: linear-gradient(135deg, #250950 0%, #150330 100%);
        }
        
        .shape-deco {
            font-size: 4rem;
            margin: 20px;
            animation: float 3s infinite ease-in-out;
        }
        
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        /* DASHBOARD */
        .dashboard {
            width: 300px;
            background: #112240;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--grid-line);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        /* TOGGLE BUTTONS */
        .mission-control { margin-bottom: 30px; text-align: center; }
        .toggle-container {
            display: flex;
            background: #0a192f;
            border-radius: 4px;
            border: 1px solid var(--grid-line);
            cursor: pointer;
        }
        .toggle-btn { flex: 1; padding: 10px; opacity: 0.5; transition: 0.3s; font-size: 0.9rem; }
        .toggle-btn.active { opacity: 1; font-weight: bold; color: #0a192f; }
        .mode-secure { background: var(--accent); }
        .mode-sabotage { background: var(--danger); }

        /* LEADERBOARD ROWS */
        .leaderboard h3 { border-bottom: 2px solid var(--grid-line); padding-bottom: 10px; margin-bottom: 15px; }
        .team-row {
            display: flex; justify-content: space-between; padding: 12px;
            background: #0a192f; margin-bottom: 8px; border-radius: 4px;
        }
        .team-blue { border-left: 4px solid var(--accent); }
        .team-red { border-left: 4px solid var(--danger); }
        .score-val { font-weight: bold; font-size: 1.2rem; }

        /* ANIMATIONS */
        .blink-green { animation: flashGreen 0.5s; }
        .blink-red { animation: flashRed 0.5s; }
        @keyframes flashGreen { 0% { background: #64ffda; color: #000; } 100% { background: #0a192f; } }
        @keyframes flashRed { 0% { background: #ff6b6b; color: #000; } 100% { background: #0a192f; } }

    </style>
</head>
<body>

    <div class="game-wrapper">
        <h1>üñ•Ô∏è CYBER_WORM v1.2</h1>
        
        <div id="game-area">
            <canvas id="gameCanvas" width="600" height="600"></canvas>
            
            <div id="start-overlay" class="overlay">
                <h2>MISSION BRIEFING</h2>
                <p>Use <b>WASD</b> or <b>ARROWS</b> to move.</p>
                <p>Select your mission mode on the right.</p>
                <button id="btn-start">INITIATE HACK</button>
            </div>

            <div id="game-over-overlay" class="overlay hidden">
                <h2 style="color: #fff">GAME OVER</h2>
                
                <div style="margin: 20px 0;">
                    <p id="result-stat" style="font-size: 1.4rem; color: var(--accent); font-weight: bold;">
                        SECURED 0 POINTS
                    </p>
                    <p id="result-message" style="color: #fff;">
                        BETTER LUCK NEXT TIME.
                    </p>
                </div>

                <button id="btn-lobby">RETURN TO HUB</button>
            </div>

            <div id="lobby-overlay" class="overlay hidden kahoot-bg">
                <h2 style="color: #fff; font-size: 3rem;">GET READY!</h2>
                
                <div style="display: flex; gap: 20px;">
                    <span class="shape-deco" style="color: #e21b3c;">‚ñ≤</span>
                    <span class="shape-deco" style="color: #1368ce;">‚óè</span>
                    <span class="shape-deco" style="color: #d89e00;">‚ñ†</span>
                </div>

                <p style="color: #fff; font-size: 1.5rem;">NEXT MODULE: <span style="font-weight:bold">SECURITY QUIZ</span></p>
                
                <div style="margin-top: 30px;">
                    <p class="blink" style="font-size: 1rem;">Waiting for host to start...</p>
                    <div style="width: 50px; height: 50px; border: 4px solid #fff; border-top: 4px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto;"></div>
                </div>

                <button onclick="startGame()" style="margin-top: 60px; border: 1px solid rgba(255,255,255,0.2); font-size: 0.8rem; opacity: 0.6;">[ MANUAL OVERRIDE: PLAY SNAKE ]</button>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="mission-control">
            <span class="mission-label" style="display:block; margin-bottom:10px; color:#8892b0; font-weight:bold;">SELECT PROTOCOL</span>
            <div class="toggle-container" onclick="toggleMode()">
                <div id="btn-secure" class="toggle-btn mode-secure active">SECURE DATA<br>(+ My Score)</div>
                <div id="btn-sabotage" class="toggle-btn mode-sabotage">SABOTAGE<br>(- Enemy Score)</div>
            </div>
        </div>

        <div class="leaderboard">
            <h3>LIVE LEADERBOARD</h3>
            <div id="row-blue" class="team-row team-blue">
                <span>üîµ TEAM BLUE</span>
                <span id="score-blue" class="score-val">0</span>
            </div>
            <div id="row-red" class="team-row team-red">
                <span>üî¥ TEAM RED</span>
                <span id="score-red" class="score-val">150</span>
            </div>
        </div>
        
        <div style="margin-top: 20px; font-size: 0.8rem; color: #8892b0;">
            <p>STATUS: <span id="status-text" style="color: var(--accent)">ONLINE</span></p>
        </div>
    </div>

    <script>
        // --- CONFIG ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const GRID = 30;
        const TILES = canvas.width / GRID;
        const SPEED = 100;

        // --- STATE ---
        let gameInterval;
        let isRunning = false;
        let snake = [];
        let dir = { x: 1, y: 0 };
        let nextDir = { x: 1, y: 0 };
        let food = { x: 10, y: 10 };
        let mode = 'secure'; 
        
        // Track current session score separately
        let sessionScore = 0;

        // Global Scores
        let scores = { blue: 0, red: 150 };

        // --- INIT ---
        window.onload = () => {
            document.getElementById('btn-start').addEventListener('click', startGame);
            document.getElementById('btn-lobby').addEventListener('click', goToLobby);
            document.addEventListener('keydown', handleInput);
            draw();
        };

        function startGame() {
            // Reset Game Logic
            snake = [{ x: 5, y: 10 }, { x: 4, y: 10 }, { x: 3, y: 10 }];
            dir = { x: 1, y: 0 };
            nextDir = { x: 1, y: 0 };
            sessionScore = 0; // Reset session score
            spawnFood();
            
            // UI Reset
            document.querySelectorAll('.overlay').forEach(el => el.classList.add('hidden'));
            document.getElementById('status-text').innerText = "INFILTRATING...";
            document.getElementById('status-text').style.color = "#64ffda";
            
            // Start Loop
            if (gameInterval) clearInterval(gameInterval);
            isRunning = true;
            gameInterval = setInterval(gameLoop, SPEED);
        }

        function toggleMode() {
            if (mode === 'secure') {
                mode = 'sabotage';
                document.getElementById('btn-secure').classList.remove('active');
                document.getElementById('btn-secure').style.opacity = '0.3';
                document.getElementById('btn-sabotage').classList.add('active');
                document.getElementById('btn-sabotage').style.opacity = '1';
            } else {
                mode = 'secure';
                document.getElementById('btn-sabotage').classList.remove('active');
                document.getElementById('btn-sabotage').style.opacity = '0.3';
                document.getElementById('btn-secure').classList.add('active');
                document.getElementById('btn-secure').style.opacity = '1';
            }
        }

        function gameLoop() {
            dir = nextDir;
            const head = { x: snake[0].x + dir.x, y: snake[0].y + dir.y };

            // Collision
            if (head.x < 0 || head.x >= TILES || head.y < 0 || head.y >= TILES || checkSelfCollision(head)) {
                gameOver();
                return;
            }

            snake.unshift(head);

            if (head.x === food.x && head.y === food.y) {
                sessionScore += 10; // Track local score
                handleGlobalScore();
                spawnFood();
            } else {
                snake.pop();
            }

            draw();
        }

        function checkSelfCollision(head) {
            for (let part of snake) {
                if (head.x === part.x && head.y === part.y) return true;
            }
            return false;
        }

        function handleGlobalScore() {
            if (mode === 'secure') {
                scores.blue += 10;
                flashRow('row-blue', 'blink-green');
            } else {
                scores.red = Math.max(0, scores.red - 10);
                flashRow('row-red', 'blink-red');
            }
            updateLeaderboard();
        }

        function flashRow(id, animClass) {
            const row = document.getElementById(id);
            row.classList.remove(animClass);
            void row.offsetWidth;
            row.classList.add(animClass);
        }

        function updateLeaderboard() {
            document.getElementById('score-blue').innerText = scores.blue;
            document.getElementById('score-red').innerText = scores.red;
        }

        function gameOver() {
            isRunning = false;
            clearInterval(gameInterval);
            
            // Prepare Game Over Text
            const resultStat = document.getElementById('result-stat');
            const resultMsg = document.getElementById('result-message');
            
            if (mode === 'secure') {
                resultStat.innerText = `SECURED ${sessionScore} POINTS`;
                resultStat.style.color = "#64ffda";
            } else {
                resultStat.innerText = `SABOTAGED ${sessionScore} POINTS`;
                resultStat.style.color = "#ff6b6b";
            }

            if (sessionScore > 0) {
                resultMsg.innerText = "CONGRATULATIONS. MISSION SUCCESSFUL.";
                resultMsg.style.color = "#fff";
            } else {
                resultMsg.innerText = "BETTER LUCK NEXT TIME. NO DATA RECOVERED.";
                resultMsg.style.color = "#8892b0";
            }

            document.getElementById('game-over-overlay').classList.remove('hidden');
            document.getElementById('status-text').innerText = "OFFLINE";
            document.getElementById('status-text').style.color = "#ff6b6b";
        }

        function goToLobby() {
            document.getElementById('game-over-overlay').classList.add('hidden');
            document.getElementById('lobby-overlay').classList.remove('hidden');
            document.getElementById('status-text').innerText = "LOBBY";
            document.getElementById('status-text').style.color = "#fff";
        }

        function spawnFood() {
            let valid = false;
            while (!valid) {
                food = {
                    x: Math.floor(Math.random() * TILES),
                    y: Math.floor(Math.random() * TILES)
                };
                valid = !checkSelfCollision(food);
            }
        }

        function draw() {
            ctx.fillStyle = '#020c1b';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // Grid
            ctx.strokeStyle = '#112240';
            ctx.lineWidth = 1;
            for (let i = 0; i < TILES; i++) {
                ctx.beginPath(); ctx.moveTo(i * GRID, 0); ctx.lineTo(i * GRID, canvas.height); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(0, i * GRID); ctx.lineTo(canvas.width, i * GRID); ctx.stroke();
            }

            // Food
            ctx.font = '24px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            let icon = mode === 'secure' ? 'üìÅ' : 'üí£';
            ctx.fillText(icon, food.x * GRID + GRID/2, food.y * GRID + GRID/2 + 2);

            // Snake
            snake.forEach((part, index) => {
                ctx.fillStyle = index === 0 ? '#64ffda' : '#40c057';
                ctx.fillRect(part.x * GRID + 1, part.y * GRID + 1, GRID - 2, GRID - 2);
                
                if (index === 0) {
                    ctx.fillStyle = '#0a192f';
                    ctx.fillRect(part.x * GRID + 6, part.y * GRID + 6, 6, 6);
                    ctx.fillRect(part.x * GRID + 18, part.y * GRID + 6, 6, 6);
                }
            });
        }

        function handleInput(e) {
            if (!isRunning) return;
            switch(e.key) {
                case 'ArrowUp': case 'w': case 'W': if (dir.y === 0) nextDir = { x: 0, y: -1 }; break;
                case 'ArrowDown': case 's': case 'S': if (dir.y === 0) nextDir = { x: 0, y: 1 }; break;
                case 'ArrowLeft': case 'a': case 'A': if (dir.x === 0) nextDir = { x: -1, y: 0 }; break;
                case 'ArrowRight': case 'd': case 'D': if (dir.x === 0) nextDir = { x: 1, y: 0 }; break;
            }
        }
    </script>
    <style>
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .blink { animation: blinker 1.5s linear infinite; }
        @keyframes blinker { 50% { opacity: 0; } }
    </style>
</body>
</html>
